{% extends "webapp/layout.html" %}

{% block content %}
<script>

    window.fbAsyncInit = function () {
        FB.init({
            appId: '1512548355444539',
            cookie: true,
            xfbml: true,
            version: 'v2.8'
        });
        FB.AppEvents.logPageView();
    };

    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) { return; }
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    FB.getLoginStatus(function (response) {
        statusChangeCallback(response);
    });

    function checkLoginState() {
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });
    }
</script>
<!--<script src="../../static/webapp/scripts/publishEventPage/pubEvent.js" type="text/javascript"></script>-->
<script>
    function post_on_wall() {
        console.log($("#eName").val())
        console.log($("#eID").val())
        console.log('post on wall')
        FB.login(function (response) {
            if (response.authResponse) {
                console.log('Logged in!');

                // Post message to your wall

                var opts = {
                    // access_token:obj.fbAt,
                    message: $("#eName").val() + "\n" + $("#eDesc").val() + "\n" + "Will depart on " + $("#eStart").val() + " from " + $('#eMeet').val() + "\n" + "And will arrive on " + $("#eEnd").val() + " at " + $('#eDest').val() + "\n" + "\n" + "Sign up by clicking the link below!",
                    place: $('#eMeet').val(),
                    name: $("#eName").val(),
                    link: 'http://www.licboathouse.org/',
                    description: $("#eDesc").val()
                    // description: obj.EventDescription + " at " + obj.EventMeetLocation
                    //picture: 'http://2.gravatar.com/avatar/8a13ef9d2ad87de23c6962b216f8e9f4?s=128&amp;d=mm&amp;r=G'
                };
                //FB.api('/196092547558918/feed', 'post', opts, function (response) {
                FB.api('/feed', 'post', opts, function (response) {
                    if (!response || response.error) {
                        console.log('Posting error occured:' + response.error.message.toString());
                        $('#Facebook_state').html('Error');
                        return "Error";
                    }
                    else {
                        console.log('Success - Post ID: ' + response.id);
                        $('#Facebook_state').html('Complete');
                        $('#Facebook_link').html('<a href="HTtp://facebook.com/' + response.id + '">View Event</a>');
                        //return response.
                    }
                });
            }
            else {
                console.log('Not logged in');
            }
        }, { scope: 'manage_pages,publish_actions,publish_pages' });
    }


</script>
<div class="card">
    <h1 class="pageHeaders" id="pubHeader">Publish "{{event.EventName}}"</h1>
    {% if not canAction %}
    <div class="alert alert-danger" style="text-align:center" role="alert">
        You don't have permission to publish events. Please contact the admin if you believe you should have access.
    </div>
    {% endif %}
    <input type="hidden" id="eName" value="{{event.EventName}}" />
    <input type="hidden" id="eStart" value="{{event.EventStart}}" />
    <input type="hidden" id="eDesc" value="{{event.EventDescription}}" />
    <input type="hidden" id="eMeet" value="{{event.EventMeetLocation}}" />
    <input type="hidden" id="eDest" value="{{event.EventDestination}}" />
    <input type="hidden" id="eEnd" value="{{event.EventEnd}}" />
    <div class="cardBody">
        <br>
        <form action="syndicate" method="post">
            <table>
                {% csrf_token %}
                {{ form.as_table}}
            </table>
            {% if not canAction %}
            <input type="submit" value="Syndicate" disabled="disabled">
            {% else %}
            <input type="submit" value="Syndicate" id="toSyndicate">
            {% endif %}
        </form>
        <form action="pubStatus" method="post">
            {% csrf_token %}
            <button name="EventID" type="submit" value="{{event.pk}}">Publish Later</button>
        </form>
    </div>
</div>
<script>
    $(document).ready(function () {

        $("body").on('click', '#toSyndicate', function () {
            if ($('#facebookPub').is(':checked')) {
                post_on_wall();
            }
        })
        var tbody = document.getElementsByTagName("tbody")[0];
        var facebookRow = document.createElement('tr');

        facebookRow.innerHTML = '<tr><th>Facebook</th><td><input type="checkbox" id="facebookPub" style="padding-right:5px"/><fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button></td></tr>';
        tbody.appendChild(facebookRow)

    })

</script>
{% endblock %}
